<!DOCTYPE html>
<html>
<head>

<!--
TODO
[x] Keep link highlighted when clicked
[x] Fix URL transformations
[ ] Add check for invalid book/chapter
[ ] Refactor code for better states. Right now there are problems with inconsistent states (highlighting)

-->

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
<script type="application/json" class="js-hypothesis-config">
  {
    "theme": "clean"
  }
</script>
<script src="https://hypothes.is/embed.js" async></script>
<script type="text/javascript" src="sidenav.js"></script>
<script type="text/javascript" src="verses.js"></script>
<script type="text/javascript" src="bookdata.js"></script>



<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" type="text/css" href="esv.css">
<link rel="stylesheet" type="text/css" href="sidenav.css">
</head>

<body>
<script>
  // This function, combined with the custom 404.html, turns this into a single-page app.
  // See https://www.smashingmagazine.com/2016/08/sghpa-single-page-app-hack-github-pages/
  (function(){
    var redirect = sessionStorage.redirect;
    delete sessionStorage.redirect;
    if (redirect && redirect != location.href) {
      history.replaceState({}, '', redirect);
    }
  })();
</script>
<div class="container">
  <div id="books" class="sidenav selectnav disable-selection">
    <div class="content"></div>
  </div>
  <div id="chapters" class="sidenav selectnav disable-selection">
    <a href="javascript:void(0)" class="closebtn" onclick="showBookSelectionView();history.back();">&times;</a>
    <div class="content"></div>
  </div>
  <div id="verses" class="sidenav">
    <a href="javascript:void(0)" class="closebtn" onclick="showChapterSelectionView();history.back();">&times;</a>
    <a href="javascript:void(0)" class="sidebtn" data-hypothesis-trigger>&#9665;</a>
    <div id="bible-content" class="content">loading...</div>
  </div>
</div>
<script type="text/javascript">

  var selectedBook = "";
  var selectedChapter = "";


  function loadStateBasedOnPath(){
    var pathArray = window.location.pathname.substr(1).split('/');
    if (pathArray[0] == "") {
      // No path
      console.log("No path");
      showBookSelectionView();
    } else if (pathArray.length == 1) {
      // Book specified
      selectedBook = pathArray[0];
      console.log("Book specified in URL: " + selectedBook);
      displayChapters(selectedBook);
      showChapterSelectionView();
    } else if (pathArray.length == 2) {
      // Book and Chapter specified
      selectedBook = pathArray[0];
      selectedChapter = pathArray[1];
      console.log("Book specified in URL: " + selectedBook);
      displayChapters(selectedBook);
      getChapterFromEsv(selectedBook, selectedChapter);
      showVersesView();
    } else {
      // Redirect to home veiw
      console.log("Invalid path");
      history.replaceState({}, '', "/");
      showBookSelectionView();
    }
  }

  for (var bookname in bookdata) {
    console.log("Book " + bookname + " has " + bookdata[bookname] + " chapters");
    $( "#books .content" ).append( "<a class='bookname' id='" + bookname + "' onclick='showChapterSelectionView()'>" + bookname + "</a>");
  }

  function displayChapters(bookname) {
    $("a").remove('.chapter');
    for (var i = 1; i <= bookdata[bookname]; i++) { 
      $("#chapters .content").append( "<a class='chapter' onclick='showVersesView()'>" + i + "</a>");
    }
  }

  function formatBookName(bookname) {
    return bookname.replace(/ /g,"+")
  }

  function highlight_selected(item){
    var itemclass = $(item).attr('class');
    $("." + itemclass).removeClass("active");
    $(item).toggleClass("active");
  }

  $('body').on('click', '.bookname', function(e) {
    var bookname = $(e.target).text();
    selectedBook = bookname;
    history.pushState({}, '', formatBookName(bookname))
    displayChapters(bookname);
    highlight_selected(this);
  });

  $('body').on('click', '.chapter', function(e) {
    var chapter = $(e.target).text();
    history.pushState({}, '', formatBookName(selectedBook) + '/' + chapter)
    getChapterFromEsv(selectedBook, chapter);
    highlight_selected(this);
  });

  $( document ).ready(function() {
    loadStateBasedOnPath();
    window.addEventListener('popstate', loadStateBasedOnPath, false);
  });

</script>
</body>
</html> 
